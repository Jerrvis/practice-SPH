# 初始化

项目名称：尚品汇

技术： Vue3 + Element-UI + Node.js + mockjs + swiper 

终端输入创建   ``` vue create app```





# day1



## 一、配置项



### 设置运行自动打开

在 package.json

把``` “scripts” : "serve" ``` 改为 ```“vue-cli-service serve --open"``` 



### 关闭eslint 校验工具

在vue.config.js中

```module.exports``` 中添加 ``` lintOnSave:false```



### 配置src简写方法

在jsconfig.js中添加如下

``` json
"compilerOptions": {
    "target": "es5",
    "module": "esnext",
    "baseUrl": "./",
    "moduleResolution": "node",
    "paths": {
      "@/*": [
        "src/*"
      ]
    }
```





## 二、路由分析

项目分为上中下结构



路由组件：

- 首页Home路由组件
- Search组件
- 登录路由
- 注册路由

非路由组件：

- Header 
- Footer(登录页面没有)



## 三、完成非路由组件Header 与Footer



**引入less样式**

第一步 安装less依赖 ``` npm install less less-loader --save```

第二步 安装less依赖 ``` npm install -g less```

第三部 js全局引入 ``` var Less = require('Less')```



## 四、路由组件搭建

安装vue-router 终端输入 ``` npm install --save vue-router ```

### 配置路由文件

vue3 中 main.js配置如下

``` js
import { createApp } from 'vue'
import App from './App.vue'

import router from '@/router'

createApp(App).use(router).mount('#app')

```



### vue3路由配置

vue3中的路由要导入新方法来正常工作，其中使用 ``` createRouter ``` 和 ``` createWebHistory ``` 方法配置，createWebHistory创建routerhistory对象

``` js
// 配置路由 
import {createRouter,createWebHistory} from 'vue-router';


const routes = [
  {
    path:'/home',
    component:()=> import('../pages/Home')
  },
  {
    path:'/search',
    component:()=> import('../pages/Search')
  },
  {
    path:'/login',
    component:()=> import('../pages/Login')
  },
  {
    path:'/register',
    component:()=> import('../pages/Register')
  }
]

const routerHistory = createWebHistory()
const router = createRouter({
  history:routerHistory,
  routes
})

export default router
```





### 路由的跳转

编程式导航路由跳转

通过配置方法主动跳转路由代码如下

``` vue
<script>
import {useRouter} from 'vue-router';
export default {
  name:"",
  setup(){
    const router = useRouter();

    // 搜索跳转路由
    let goSearch =  ()=>{
      router.push('/search')
    }

    return{
      goSearch
    }
  }
};
</script>
```





### 路由传参

在路由中设置好params参数的占位符

``` js
const routes = [
  ......
  {
    name:'search',
    path:'/search/:keyword?', // keyword站位符 接受params参数(?表示可传可不传)
    component:()=> import('../pages/Search'),
    meta:{show:true}
  },
  ......
]
```



如下为vue3 路由传参的方法

path的对象方法 只能传query参数（params 可在path中配置）

``` vue
<script>
import { useRouter } from "vue-router";
import { ref } from "vue";
export default {
  name: "",
  setup() {
    const router = useRouter();

    let keyword = ref("");
    let goSearch = function () {
      // 字符串形式传参 搜索跳转路由 可传params
      // router.push('/search/'+this.keyword +'?k=' + this.keyword.toUpperCase())
      // 对象传参 params 需要路由命名
      // router.push({name:'search',params:{keyword:this.keyword},query:{k:this.keyword.toUpperCase()}})
      // 其他对象写法（params 要在path中配置）
      // router.push({path:'/search/'+this.keyword,query:{k:this.keyword.toUpperCase()}})
    };

    return {
      goSearch,
      keyword,
    };
  },
};
</script>
```



**指定参数可传可不传**

``` path:'/search/:keyword?'``` keyword站位符 接受params参数(?表示可传可不传)



**params参数为空**

使用如下方法解决params 参数为空的问题

```router.push({name:'search',params:{keyword:''||undefined},query:{k:this.keyword.toUpperCase()}})```



**路由props传参**

``` js
const routes = [
  ......
  {
    name:'search',
    path:'/search/:keyword?', // keyword站位符 接受params参数(?表示可传可不传)
    component:()=> import('../pages/Search'),
    meta:{show:true},
    // props:true, // 布尔写法 允许props传参 用params传参
    // props:{a:1,b:2} // 对象写法 给路由租借额外传参
    
    // 函数写法
    props:(route) =>{ 
      return {keyword:route.params.keyword,k:route.query.k}
    } 
  },
  ......
]
```

组件接受参数

``` vue
<template>
  <div>
    <h1>params参数:{{keyword}}</h1>
    <h1>query参数:{{k}}</h1>
  </div>
</template>

<script>
export default {
  name:'Search',
  props:['keyword','k']
}
</script>
```





***



# day2



## 编程式路由重复push错误

编程式路由跳转到当前路由（参数不变），多次执行会抛出警告错误，在声明式导航中不存在该问题。（Vue3中不存在该问题 ）

错误的原因是因为在 push 中有return 回调结果



通过给push方法给予成功与失败的回调，可以捕获到当前的错误

``` let res = router.push({name:'search',params:{keyword:this.keyword||undefined},query:{k:this.keyword.toUpperCase()}},()=>{console.log('success')},(error)=>console.log(error))```

建议重写push方法

``` js
// 先保存原型push一份
let originPush VueRouter.prototype.push;

// 重写push
VueRouter.prototype.push = function (location,resolve, reject){
    if (resolve && reject){
        originPush.call(this,location,resolve,reject);
    }else {
        originPush.call(this,location,()=>{},()=>{})
    }
}
```





## 首页组件



### Nav三级联动组件

三级联动组件在多页面中都在使用，可以注册为全局组件，可在项目任意地方中使用。

main.js中配置如下



``` js
import { createApp } from 'vue'
import App from './App.vue'

// 引入路由
import router from '@/router'
// 三级联动组件 全局注册
import TypeNav from '@/pages/Home/TypeNav'

const app = createApp(App)

app.use(router)
app.component('typenav',TypeNav)
app.mount('#app')
```







## ApiPost 测试接口

- 经过ApiPost 测试没有问题
- 如果服务器返回的数据Code字段200，表示返回数据成功
- 整个项目接口都有api字样





## Axios二次封装

XMLHttpRequest\ fetch\ JQ\ axios



二次封装axios 为了设置请求拦截器与响应拦截器

​		请求拦截器：发请求前处理事情

​		响应拦截器：发请求后处理事情



接口封装放在 src/api 文件夹下

``` js
// 对于axios进行二次封装

import axios from 'axios';


// 利用axios 方法create 创建一个实例
// request 就是 axios
const requests = axios.create({
  // 基础路径
  baseURL:'/api',
  // 代表请求超时时间为5s
  timeout:5000,
});

// 请求拦截器,发请求前，请求拦截器可以拦截，可以执行部分代码
requests.interceptors.request.use((config)=>{
  // config 为配置对象，
  //里面有header 请求头
  return config
})

// 响应拦截器
requests.interceptors.response.use((res)=>{
  // 响应成功文档
  return res.data
},(error)=>{
  // 响应失败的回调函数
  return Promise.reject(new error('faild'))
})

export default requests;
```



## 接口统一管理

项目较小：完全你可以在组件的生命周期函数中发请求

项目大：axios.ge('xxx')



src/api文件夹中再创建 index.js 文件管理api地址





## 跨域问题

协议、域名、端口号不同的请求存在跨域问题

解决方法：JSONP \ CROS \ 代理



vue.config.js配置跨域代理

``` js
// 代理跨域
  devServer:{
    proxy:{
      '/api':{
        target:'http://localhost:8000',
        pathRewrite:{'^/api':''}
      }
    }
  }
```





***



## nprogress 进度条的使用

在进度发送请求的时候让进度条运动，请求结束后进度条停止运动

在终端中输入 ``` npm install --save nprogress ``` 来为项目安装nprogress

start:进度条开始

done:进度条结束



在api/requests 中配置进度条如下

``` js
// 对于axios进行二次封装

import axios from 'axios';
// 引入进度条
import nprogress from 'nprogress';
// start ：进度条开始      done:进度条结束
// 引入进度条样式
import 'nprogress/nprogress.css';

// 利用axios 方法create 创建一个实例
// request 就是 axios
const requests = axios.create({
  // 基础路径
  baseURL:'/api',
  // 代表请求超时时间为5s
  timeout:5000,
});

// 请求拦截器,发请求前，请求拦截器可以拦截，可以执行部分代码
requests.interceptors.request.use((config)=>{
  // 进度条开始
  nprogress.start();
  // config 为配置对象，
  //里面有header 请求头
  return config
})

// 响应拦截器
requests.interceptors.response.use((res)=>{
  // 进度条结束
  nprogress.done();
  // 响应成功文档
  return res.data
},(error)=>{
  // 进度条结束
  nprogress.done();
  // 响应失败的回调函数
  return Promise.reject(new error('faild'))
})

export default requests;
```



***



## vuex状态管理库

vuex是官方提供的一个插件，状态管理库，集中式管理项目中组件共用的数据。

较小的项目不需要使用vuex，不要为使用vuex而去使用vuex。



终端输入 ``` npm install --save vuex ``` 安装vuex

src/store 中配置vuex 文件

index.js

``` js
import Vue from 'vue';
import Vuex from 'vuex';


// state:仓库存储数据的地方
const state = {};
// mutations: 修改state 的唯一手段
const mutations = {};
// action: 处理action,可以书写自己的业务逻辑
const actions = {};
// getters: 理解为计算属性，用于简化仓库数据，让组件获取仓库数据更加方便
const getters = {};

// 对外暴露store 类的一个实例

export default new Vuex.Store({
  state, mutations, actions, getters 
});
```

在入口文件 main.js 中配置如下

``` js
// 引入vuex
import store from '@/store'
app.use(store)
```





### 使用方式

src/store 配置如下

``` js
// state:仓库存储数据的地方
const state = {
  count:0,
};
// mutations: 修改state 的唯一手段
const mutations = {
  countADD(state,value){
    state.count += value;
  }
};
// action: 处理action,可以书写自己的业务逻辑
const actions = {
  // 可以写业务逻辑,但不能修改state
  //触发mutations方法修改属性，通常在组件中使用dispatch触发action,而不是直接commit
  countAdd({commit}){
    commit('countADD',1); 
  }
};
```

组件中使用如下

``` vue

<template>
  <div>
	<button @click="add">点击我加1</button>
    <button>点击我减1</button>
    <span>仓库的数据{{count}}</span>
  </div>
</template>

<script>
// 引入vuex
import $store from '@/store'
import { computed } from '@vue/runtime-core'
export default {
  name:'Home',
  components: { 
    ...
  },
  setup(){
    // 计算属性绑定
    
    let count = computed(()=>{return $store.state.count})
	
    // 触发action
    let add = ()=>{$store.dispatch("countAdd")}
    return {
      count,
      add
    }
  }
  
}
</script>
```



### 模块式存储

目录配置如下

```
src
|---store
|-----|----index.js
|-----|----home
|-----|------|----index.js
|-----|----search
|-----|------|----index.js
```



store/home/index.js配置为

``` js
// home 模块的仓库

const state = {
  count:0,
};
const mutations = {
  countADD(state,value){
    state.count += value;
  }
};
const actions = {
  countAdd({commit}){
    commit('countADD',1);
  }
};
const getters = {};

export default{
  state, mutations, actions, getters
}
```

store/search/index.js配置为

``` js
// search 模块的仓库

const state = {};
const mutations = {};
const actions = {};
const getters = {};

export default{
  state, mutations, actions, getters
}
```

store/index.js 引入所有模块store

``` js
import Vuex from 'vuex';

// 引入模块仓库
import home from './home'
import search from './search'



export default new Vuex.Store({
  modules:{home,search} 
});
```

vue 组件中使用如下

```vue
<template>
  <div>
    <button @click="add">点击我加1</button>
    <button>点击我减1</button>
    <span>仓库的数据{{count}}</span>
  </div>
</template>

<script>
// 引入vuex
import store from '@/store'
import { computed } from '@vue/runtime-core'
export default {
  name:'Home',
  components: { 
    ...
  },
  setup(){
    let count = computed(()=>{return store.state.home.count})
	
    let add = ()=>{store.dispatch("countAdd",'home')}
    return {
      count,
      add
    }
  }
  
}
</script>
```



***



## 三级联动组件展示

数据获取

配置vuex配置如下

``` js
const state = {
  categoryList:[]
};
const mutations = {
  CATEGORYLIST(state,categoryList){
    state.categoryList = categoryList;
  }
};
const actions = {
  async categoryList({commit}){
    let result = await reqCategoryList();
    if (result.code == 200){
      commit("CATEGORYLIST",result.data)
    }
  }
};
```

使用v-for渲染三级联动组件如下

``` vue
<template>
  <!-- 商品分类导航 -->
  <div class="type-nav">
    <div class="container">
      <h2 class="all">全部商品分类</h2>
      <nav class="nav">
        <a href="###">服装城</a>
        <a href="###">美妆馆</a>
        <a href="###">尚品汇超市</a>
        <a href="###">全球购</a>
        <a href="###">闪购</a>
        <a href="###">团购</a>
        <a href="###">有趣</a>
        <a href="###">秒杀</a>
      </nav>
      <div class="sort">
        <div class="all-sort-list2">
          <div class="item" v-for="(c1) in categoryList" :key="c1.categoryId">
            <h3>
              <a href="">{{c1.categoryName}}</a>
            </h3>
            <div class="item-list clearfix">
              <div class="subitem"  v-for="(c2) in c1.categoryChild" :key="c2.categoryId">
                <dl class="fore">
                  <dt>
                    <a href="">{{c2.categoryName}}</a>
                  </dt>
                  <dd>
                    <em v-for="(c3) in c2.categoryChild" :key="c3.categoryId">
                      <a href="">{{c3.categoryName}}</a>
                    </em>
                  </dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { computed, onMounted } from "@vue/runtime-core";
import { useStore, mapState } from "vuex";
export default {
  name: "TypeNav",
  // mapstate
  computed: {
    ...mapState({ categoryList: (state) => state.home.categoryList }),
  },
  setup() {
    const store = useStore();
    // 组件挂载完毕 向服务器发送请求
    onMounted(() => {
      // 将请求得到的数据储存在仓库内
      store.dispatch("categoryList", "home");
    });
  },
};
</script>
```





***



# day3



## 一级分类动态添加颜色

1. 解决方案1		Sstyle样式中添加hover即可
2. 解决方案2       使用事件委派,class添加

``` vue
<template>
  <!-- 商品分类导航 -->
  <div class="type-nav">
    <div class="container">
      <div @mouseleave="leaveIndex">
        <h2 class="all">全部商品分类</h2>
        <div class="sort">
          <div class="all-sort-list2">
            <!-- 鼠标在那个类名上，那个类名就存在class:cur -->
            <div
              class="item"
              v-for="(c1, index) in categoryList"
              :key="c1.categoryId"
              :class="{ cur: currentIndex == index }"
            >
              <h3 @mouseenter="changeIndex(index)">
                <a href="">{{ c1.categoryName }}</a>
              </h3>
              <div class="item-list clearfix">
                <div
                  class="subitem"
                  v-for="c2 in c1.categoryChild"
                  :key="c2.categoryId"
                >
                  <dl class="fore">
                    <dt>
                      <a href="">{{ c2.categoryName }}</a>
                    </dt>
                    <dd>
                      <em v-for="c3 in c2.categoryChild" :key="c3.categoryId">
                        <a href="">{{ c3.categoryName }}</a>
                      </em>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <nav class="nav">
        <a href="###">服装城</a>
        <a href="###">美妆馆</a>
        <a href="###">尚品汇超市</a>
        <a href="###">全球购</a>
        <a href="###">闪购</a>
        <a href="###">团购</a>
        <a href="###">有趣</a>
        <a href="###">秒杀</a>
      </nav>
    </div>
  </div>
</template>

<script>
import { computed, onMounted, reactive, ref} from "@vue/runtime-core";
import { useStore, mapState } from "vuex";
export default {
  name: "TypeNav",
  // mapstate
  ...
  setup() {
    ....
    // 当前鼠标在那个元素
    let currentIndex = ref(-1);
    let changeIndex = function (index) {
      currentIndex.value = index;
    };
    // 当前鼠标离开元素
    let leaveIndex = function () {
      console.log('leave')
      currentIndex.value = -1;
    };

    return {
      changeIndex,
      currentIndex,
      leaveIndex,
    };
  },
};
</script>
<style  lang="less" scoped>
.type-nav {
  border-bottom: 2px solid #e1251b;
    ...
      .all-sort-list2 {
        .item {
        }
          // 添加cur类样式
        .cur {
          background: skyblue;
        }
        // .item:hover{
        //   color: skyblue; // 添加鼠标悬停颜色
        // }
      }
    }
  }
}
</style>
```



***



## 二三级分类隐藏



二三级分类改为如下可控制显示与隐藏

``` html
<!-- 二三级分类 -->
              <div class="item-list clearfix" 
              :style="{display:currentIndex == index?'block':'none'}">
```



***



## 卡顿现象

正常：事件触发非常频繁，而且每一次的触发，回调函数都要去执行（如果事件较短，回调函数有内部计算，浏览器会比较卡）



节流：在规定时间范围内不会重复触发回调，只有大于这个时间间隔才会触发回调，把频繁触发改为少量触发

防抖：前面的所有的触发都被取消，最后一次执行在规定时间之后才会触发，也就是说如果连续快速的触发，只会触发一次。



**节流实现**

1. 使用lodash实现



**防抖实现**

1. 使用lodash插件实现
2. Vue3可使用customRef实现（详见天禹老师的vue3 customRef ）



``` vue
<template>
...
</template>

<script>
import {onMounted,  ref, customRef } from "@vue/runtime-core";
import { useStore, mapState } from "vuex";
import { throttle } from 'lodash';
export default {
  name: "TypeNav",
  ...
  setup() {
    ...

    // let currentIndex = ref(-1);
    // 设置lodash节流器
    let changeIndex = throttle(function (index) {
      currentIndex.value = index;
    },50)
    // 当前鼠标离开元素
    let leaveIndex = function () {
      currentIndex.value = -1;
    };
    
    //通过vue3的customRef去实现防抖
    function antishakeRef(value, delay) {
      let timer;
      return customRef((track, trigger) => {
        return {
          get() {
            track(); //告诉Vue这个value值是需要被“追踪”的
            return value;
          },
          set(newValue) {
            clearTimeout(timer);
            timer = setTimeout(() => {
              value = newValue;
              trigger(); //告诉Vue去更新界面
            }, delay);
          },
        };
      });
    }



    // 设置防抖时间为5ms，初始化被跟踪数据为-1
    let currentIndex = antishakeRef(-1,50);


    return {
      changeIndex,
      currentIndex,
      leaveIndex,
    };
  },
};
</script>
```



***



## 三级联动路由跳转

三级联动用户可以点击：一、二、三级分类，当你点击的时候Home模块跳转到Search模块，会把用户选中的产品进行搜索

router-link:使用过多会产生卡顿，建议使用原生a标签编程式导航



``` vue
<template>
  <!-- 商品分类导航 -->
  <div class="type-nav">
    <div class="container">
      <div @mouseleave="leaveIndex">
        <h2 class="all">全部商品分类</h2>
        <div class="sort">
          <div class="all-sort-list2" @click="goSearch">
            <!-- 鼠标在那个类名上，那个类名就存在class:cur -->
            <div
              class="item"
              v-for="(c1, index) in categoryList"
              :key="c1.categoryId"
              :class="{ cur: currentIndex == index }"
            >
              <h3 @mouseenter="changeIndex(index)">
                <a href="" :data-categoryname="c1.categoryName"
                :date-category1id="c1.categoryId">{{ c1.categoryName }}</a>
                <!-- <router-link to="/search">{{ c1.categoryName }}</router-link> -->
              </h3>
              <!-- 二三级分类 -->
              <div
                class="item-list clearfix"
                :style="{ display: currentIndex == index ? 'block' : 'none' }"
              >
                <div
                  class="subitem"
                  v-for="c2 in c1.categoryChild"
                  :key="c2.categoryId"
                >
                  <dl class="fore">
                    <dt>
                      <a href="" :data-categoryname="c2.categoryName"
                      :date-category2id="c2.categoryId">{{ c2.categoryName }}</a>
                      <!-- <router-link to="/search">{{ c2.categoryName }}</router-link> -->
                    </dt>
                    <dd>
                      <em v-for="c3 in c2.categoryChild" :key="c3.categoryId">
                        <a href="" :data-categoryname="c3.categoryName"
                        :date-category3id="c3.categoryId">{{ c3.categoryName }}</a>
                        <!-- <router-link to="/search">{{ c3.categoryName }}</router-link> -->
                      </em>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <nav class="nav">
        <a href="###">服装城</a>
        <a href="###">美妆馆</a>
        <a href="###">尚品汇超市</a>
        <a href="###">全球购</a>
        <a href="###">闪购</a>
        <a href="###">团购</a>
        <a href="###">有趣</a>
        <a href="###">秒杀</a>
      </nav>
    </div>
  </div>
</template>

<script>
import { onMounted, customRef } from "@vue/runtime-core";
import { useRouter } from 'vue-router'
import { useStore, mapState } from "vuex";
import { throttle } from 'lodash';
export default {
  name: "TypeNav",
  ...
  setup() {
    
    ...
    const router = useRouter();
    const store = useStore();

    // 事件委派实现搜索功能
    let goSearch = function(event){
      //子节点a标签中加上 :dataCategoryName的自定义属性

      // 获取到当前触发时间的节点，需要带有dataCategory属性
      let element = event.target;
      let {categoryname,category1id,category2id,category3id} = element.dataset;
      if(categoryname){
        let query = {categoryName:categoryname}
        if(category1id){
          console.log(category1id)
          query.category1Id = category1id;
        }else if(category2id){
          query.category2Id = category2id;
        }else if(category3id){
          query.category3Id = category3id;
        }
        router.push({name:'search',query})
      }
    }
    
    return {
      changeIndex,
      currentIndex,
      leaveIndex,
      goSearch
    };
  },
};
</script>
```





***



# day4

## 三级联动菜单回收问题

使用v-show 或 v-if 来显示



## 添加过渡动画

元素必须要有v-show 或 v-if 才能使用过渡动画

``` vue
<template>
  <!-- 商品分类导航 -->
  <div class="type-nav">
    <div class="container">
      <div @mouseleave="leaveIndex" @mouseenter="enterShow">
        <h2 class="all">全部商品分类</h2>
        <!-- 过渡动画 -->
        <transition name="sort">
          <div class="sort" v-show="showList">
          </div>
        </transition>

      	</div>
        <nav class="nav">
        </nav>
    </div>
  </div>
</template>

<script>
...
</script>

<style  lang="less" scoped>
.type-nav {
...
    // 过渡动画开始状态
    .sort-enter{
      height: 0;
      
    }
    // 过渡动画结束状态
    .sort-enter-to{
      height: 461px;
    }
    .sort-enter-active{
      transition: all .5s linear;
    }
  }
}
</style>

```



***

## 三级联动重复发送请求

获取商品分类列表的函数放在app组件，让它只执行一次，切换路由时候不再需要发送请求

``` vue
<script>
import Header from './components/header'
import Footer from './components/footer'
import { onMounted } from '@vue/runtime-core'
export default {
  name:'app',
  components:{Header,Footer},
  setup(){
    // 获取商品分类三级列表的数据
    onMounted(()=>{
      store.dispatch("categoryList", "home");
    })
  }
}
</script>
```



***



## 合并params与query参数

在搜索功能中尽可能地调用params参数与query参数

``` js
// header 组件
let goSearch = function () {
      // 字符串形式传参 搜索跳转路由 可传params
      // router.push('/search/'+this.keyword +'?k=' + this.keyword.toUpperCase())
      // 对象传参 params 需要路由命名
      let location = {
        name: "search",
        params: { keyword: this.keyword || undefined },
      };
      if (route.query) {
        location.query = route.query;
      }
      console.log(location);
      router.push(location);
      // 其他对象写法
      // router.push({path:'/search/'+this.keyword,query:{k:this.keyword.toUpperCase()}})

    }
    return {
        goSearch,
        keyword,
    };
```



``` js
// TypeNav 组件
let goSearch = function(event){
      //子节点a标签中加上 :dataCategoryName的自定义属性

      // 获取到当前触发时间的节点，需要带有dataCategory属性
      let element = event.target
      let {categoryname,category1id,category2id,category3id} = element.dataset;
      if(categoryname){
        let location = {name:'search'}
        let query = {categoryName:categoryname}
        if(category1id){
          query.category1Id = category1id
        }else if(category2id){
          query.category2Id = category2id
        }else if(category3id){
          query.category3Id = category3id
        }
        location.query = query
        if (route.params){
          location.params = route.params;
        }
        console.log(location)
        router.push(location)
      }
    }
```



***



## 首页轮播图

## mock

开发Home首页中的ListContainer 组件与floor组件

docschina.org

但是这里需要知道一件事：服务器返回的数据（接口）只有商品分类菜单分类数据

因此需要mock数据（模拟）：需要使用mock.js插件

mockjs能够生成随机数据拦截ajax请求



**mock的使用**

1. src下创建一个mock文件夹
2. 准备json数据
3. 把mock数据需要的图片放置到public文件夹中
4. 创建mockServe.js 开始mock（虚拟数据）
5. 在main.js中引入执行一次

mockServe配置如下

``` js
// 引入mockjs模块
import Mock from 'mockjs';

// 引入json数据格式(json文件不需要配置，默认暴露)
import banner from './banner.json'
import floor from './floor.json'

// mock数据：第一个参数请求地址 第二个数据 请求数据
Mock.mock('/mock/banner',{code:200,data:banner});
Mock.mock('/mock/floor',{code:200,data:floor});


```



***

## Swiper轮播图

```npm i install```安装swpier

``` vue
<template>
  <div class="list-container">
    <div class="sortList clearfix">
      <div class="center">
        <swiper
          :modules="modules"
          :slides-per-view="1"
          :space-between="50"
          navigation
          :autoplay="true"
          :pagination="{ clickable: true }"
          :scrollbar="{ draggable: true }"
        >
          <swiper-slide v-for="carousel in bannerList" :key="carousel.id">
            <img :src="carousel.imgUrl" />
          </swiper-slide>
        </swiper>
      </div>
      <div>
          ...
      </div>
    </div>
  </div>
</template>

<script>
import { onMounted } from "@vue/runtime-core";
import { mapState, useStore } from "vuex";
// import Swiper core and required modules
import { Navigation, Pagination, Scrollbar, A11y, Autoplay } from "swiper";

// Import Swiper Vue.js components
import { Swiper, SwiperSlide } from "swiper/vue";

// Import Swiper styles
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/pagination";
import "swiper/css/scrollbar";

export default {
  name: "ListContainer",
  components: { Swiper, SwiperSlide },
  computed: {
    ...mapState({
      bannerList: (state) => state.home.bannerList,
    }),
  },
  setup() {
    const store = useStore();
    const onSwiper = (swiper) => {
      console.log(swiper);
    };
    const onSlideChange = () => {
      console.log("slide change");
    };
    return {
      onSwiper,
      onSlideChange,
      modules: [Navigation, Pagination, Scrollbar, A11y, Autoplay],
    };
  },
};
</script>
```



以下图为案例

![image-20220414085629182](.assets/开发日志/image-20220414085629182.png)

如下为 pagination 底下圆点分页器

![image-20220414085650084](.assets/开发日志/image-20220414085650084.png)

如下为 scrollbar 底下滚动条

![image-20220414085756869](.assets/开发日志/image-20220414085756869.png)

如下为navigation 为左右按钮

![image-20220414090038594](.assets/开发日志/image-20220414090038594.png)



```:autoplay="true" ```为自动轮播相当于

``` js
autoplay: {
    delay: 3000,
    stopOnLastSlide: false,
    disableOnInteraction: true,
    }
```



***

# day5



## 开发floor组件

与轮播图同解 在app 组件中mock数据放入 store中

使用 v-for 循环组件并传入数据

``` vue
<template>
  <div>
    <!-- 三级联动已经注册为全局组件，不需要引用 -->
    <type-nav/>
    <ListContainer/>
    <Recommend/>
    <Rank/>
    <Like/>
    <Floor v-for="(floor) in floorList" :key="floor.id" :List="floor" />
    <Brand/>
    <!-- <button @click="add">点击我加1</button>
    <button>点击我减1</button>
    <span>仓库的数据{{count}}</span> -->
  </div>
</template>

<script>
import ListContainer from '@/pages/Home/ListContainer'
import Recommend from '@/pages/Home/Recommend'
import Rank from '@/pages/Home/Rank'
import Like from '@/pages/Home/Like'
import Floor from '@/pages/Home/Floor'
import Brand from '@/pages/Home/Brand'
// 引入vuex
import { mapState } from 'vuex';
import store from '@/store'
import { computed } from '@vue/runtime-core'
export default {
  name:'Home',
  components: { 
    ListContainer, 
    Recommend, 
    Rank,
    Like,
    Floor,
    Brand 
  },
    computed:{
    ...mapState({floorList:(state)=> state.home.floorList})
  },
  setup(){
    // let count = computed(()=>{return store.state.home.count})
    // let add = ()=>{store.dispatch("countAdd",'home')}
    return {
      // count
    }
  }
  
}
</script>

<style>

</style>
```



***



## 拆分出轮播图组件

在考法中某种结构多次复用可以拆分为组件

轮播图全局组件代码如下

``` vue
<template>
  <swiper
    :loop="true"
    :modules="modules"
    :slides-per-view="1"
    :space-between="50"
    navigation
    :autoplay="true"
    :pagination="{ clickable: true }"
  >
  <!-- :scrollbar="{ draggable: addScrollbar }" -->
    <swiper-slide
      class="swiper-slide"
      v-for="carousel in list"
      :key="carousel.id"
    >
      <img :src="carousel.imgUrl" />
    </swiper-slide>
  </swiper>
</template>

<script>
// import Swiper core and required modules
import { Navigation, Pagination, Scrollbar, A11y, Autoplay } from "swiper";

// Import Swiper Vue.js components
import { Swiper, SwiperSlide } from "swiper/vue";

// Import Swiper styles
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/pagination";
import "swiper/css/scrollbar";
export default {
  name: "myswiper",
  components: { Swiper, SwiperSlide },
  props: ["list"],
  setup() {
    return {
      modules: [Navigation, Pagination, Scrollbar, A11y, Autoplay],
    };
  },
};
</script>

<style>
</style>
```



``` html
        <my-swiper :list='bannerList'>
        </my-swiper> <!-- listContainer 组件使用并传参 -->
        <my-swiper :list='list.carouselList'>
        </my-swiper> <!-- floor 组件使用并传参 -->
```





***

## search 模块开发



1. 先写好静态页面

2. 根据api接口写好请求函数

``` js
// 获取商品搜索数据
/**
 * 需要带参数
 * {
  "category3Id": "61",
  "categoryName": "手机",
  "keyword": "小米",
  "order": "1:desc",
  "pageNo": 1,
  "pageSize": 10,
  "props": ["1:1700-2799:价格", "2:6.65-6.74英寸:屏幕尺寸"],
  "trademark": "4:小米"
}

params参数至少为空对象
*/
export const reqGetSearchInfo = (params)=>requests({
  url:'/list',
  method:'post',
  data:params
})
```



3. 配置vuex三连环

使用getters 绑定全局计算属性

``` js
// search 模块的仓库

// 引入搜索函数
import { reqGetSearchInfo } from "@/api";

const state = {
  searchList:{}
};
const mutations = {
  GETSEARCHLIST(state, value){
    // 返回的数据为对象
    state.searchList = value
  }
};
const actions = {
  async getSearchList({commit},params={}){
    let result = await reqGetSearchInfo(params);
    if(result.code == 200){
      commit("GETSEARCHLIST",result.data)
    }
  }
};
// getters主要作用是：简化仓库中的数据
// 可以把我们将来在组件中的数据简化一下
const getters = {
  // 传入的参数为当前search仓库的state，并非大仓库的state
  // 数据为undefinded返回空数组 [] 
  goodsList(state){
    return state.searchList.goodsList || []
  },
  trademarkList(state){
    return state.searchList.trademarkList || []
  },
  attrsList(state){
    return state.searchList.attrsList || []
  }
};

export default{
  state, mutations, actions, getters
}
```



``` vue
<template>
  <div>
    <!-- 这是search模块 -->
    <type-nav />

    <!-- 搜索页面内容展示 -->
    <!--list-content-->
    <div class="main">
      <div class="py-container">
        <!--bread 面包屑 关闭筛选条件-->
        <div class="bread">
          <ul class="fl sui-breadcrumb">
            <li>
              <a href="#">全部结果</a>
            </li>
          </ul>
          <ul class="fl sui-tag">
            <li class="with-x">手机</li>
            <li class="with-x">iphone<i>×</i></li>
            <li class="with-x">华为<i>×</i></li>
            <li class="with-x">OPPO<i>×</i></li>
          </ul>
        </div>
        <!--selector-->
        <SearchSelector>
        </SearchSelector>
        <!--details-->
        <div class="details clearfix">
          <div class="sui-navbar">
            <div class="navbar-inner filter">
              <ul class="sui-nav">
                <li class="active">
                  <a href="#">综合</a>
                </li>
                <li>
                  <a href="#">销量</a>
                </li>
                <li>
                  <a href="#">新品</a>
                </li>
                <li>
                  <a href="#">评价</a>
                </li>
                <li>
                  <a href="#">价格⬆</a>
                </li>
                <li>
                  <a href="#">价格⬇</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="goods-list">
            <ul class="yui3-g">
              <!-- 商品列表 -->
              <li class="yui3-u-1-5" v-for="good in goodsList" :key="good.id">
                <div class="list-wrap">
                  <div class="p-img">
                    <a href="item.html" target="_blank"
                      ><img :src="good.defaultImg"
                    /></a>
                  </div>
                  <div class="price">
                    <strong>
                      <em>¥</em>
                      <i>{{ good.price }}</i>
                    </strong>
                  </div>
                  <div class="attr">
                    <a
                      target="_blank"
                      href="item.html"
                      title="促销信息，下单即赠送三个月CIBN视频会员卡！【小米电视新品4A 58 火爆预约中】"
                      >{{ good.title }}</a
                    >
                  </div>
                  <div class="commit">
                    <i class="command">已有<span>2000</span>人评价</i>
                  </div>
                  <div class="operate">
                    <a
                      href="success-cart.html"
                      target="_blank"
                      class="sui-btn btn-bordered btn-danger"
                      >加入购物车</a
                    >
                    <a href="javascript:void(0);" class="sui-btn btn-bordered"
                      >收藏</a
                    >
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <div class="fr page">
            <div class="sui-pagination clearfix">
              <ul>
                <li class="prev disabled">
                  <a href="#">«上一页</a>
                </li>
                <li class="active">
                  <a href="#">1</a>
                </li>
                <li>
                  <a href="#">2</a>
                </li>
                <li>
                  <a href="#">3</a>
                </li>
                <li>
                  <a href="#">4</a>
                </li>
                <li>
                  <a href="#">5</a>
                </li>
                <li class="dotted"><span>...</span></li>
                <li class="next">
                  <a href="#">下一页»</a>
                </li>
              </ul>
              <div><span>共10页&nbsp;</span></div>
            </div>
          </div>
        </div>
        <!--hotsale-->
        <div class="clearfix hot-sale">
          <h4 class="title">热卖商品</h4>
          <div class="hot-list">
            <ul class="yui3-g">
              <li class="yui3-u-1-4">
                <div class="list-wrap">
                  <div class="p-img">
                    <img src="./images/like_01.png" />
                  </div>
                  <div class="attr">
                    <em>Apple苹果iPhone 6s (A1699)</em>
                  </div>
                  <div class="price">
                    <strong>
                      <em>¥</em>
                      <i>4088.00</i>
                    </strong>
                  </div>
                  <div class="commit">
                    <i class="command">已有700人评价</i>
                  </div>
                </div>
              </li>
              <li class="yui3-u-1-4">
                <div class="list-wrap">
                  <div class="p-img">
                    <img src="./images/like_03.png" />
                  </div>
                  <div class="attr">
                    <em>金属A面，360°翻转，APP下单省300！</em>
                  </div>
                  <div class="price">
                    <strong>
                      <em>¥</em>
                      <i>4088.00</i>
                    </strong>
                  </div>
                  <div class="commit">
                    <i class="command">已有700人评价</i>
                  </div>
                </div>
              </li>
              <li class="yui3-u-1-4">
                <div class="list-wrap">
                  <div class="p-img">
                    <img src="./images/like_04.png" />
                  </div>
                  <div class="attr">
                    <em>256SSD商务大咖，完爆职场，APP下单立减200</em>
                  </div>
                  <div class="price">
                    <strong>
                      <em>¥</em>
                      <i>4068.00</i>
                    </strong>
                  </div>
                  <div class="commit">
                    <i class="command">已有20人评价</i>
                  </div>
                </div>
              </li>
              <li class="yui3-u-1-4">
                <div class="list-wrap">
                  <div class="p-img">
                    <img src="./images/like_02.png" />
                  </div>
                  <div class="attr">
                    <em>Apple苹果iPhone 6s (A1699)</em>
                  </div>
                  <div class="price">
                    <strong>
                      <em>¥</em>
                      <i>4088.00</i>
                    </strong>
                  </div>
                  <div class="commit">
                    <i class="command">已有700人评价</i>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- <button @click="csl">点我测试</button> -->
  </div>
</template>

<script>
import { computed, onBeforeMount, onMounted, reactive, watch } from "@vue/runtime-core";
import { mapGetters, useStore } from "vuex";
import { useRoute } from 'vue-router';
import SearchSelector from './SearchSelector'
export default {
  components: { SearchSelector },
  name: "Search",
  props: ["keyword", "k"],
  // vue2 mapGetters 写法
  // computed:{
  //   ...mapGetters(['goodsList'])
  // },
  component:{SearchSelector},
  setup() {
    const store = useStore();
    const route = useRoute();

    // 向服务器发送的请求
    let searchParams = reactive({
      category1Id: "",
      category2Id: "",
      category3Id: "",
      categoryName: "",
      keyword: "",
      order: "",
      pageNo: 1,
      pageSize: 10,
      props: [],
      trademark: "",
    });

    // 把请求封装为一个函数
    let getData = function () {
      store.dispatch("getSearchList", searchParams);
    };
    
    // 初始化数据
    onBeforeMount(()=>{
      // searchParams.category1Id = route.query.category1Id;
      // searchParams.category2Id = route.query.category2Id;
      // searchParams.category3Id = route.query.category3Id;
      // searchParams.categoryName = route.query.categoryName;
      // searchParams.keyword = route.query.keyword;
      // searchParams.order = route.query.order;
      // searchParams.pageNo = route.query.pageNo;
      // searchParams.trademark = route.query.trademark;

      Object.assign(searchParams,route.query,route.params);
      console.log(searchParams)
    })

    onMounted(() => {
      getData();
    });

    watch(searchParams,(newValue,oldValue)=>{
      store.dispatch("getSearchList", searchParams);
    },{immediate:true});

    // vue3 mapGetters 写法
    const goodsList = computed(
      mapGetters(["goodsList"]).goodsList.bind({ $store: store })
    );

    // 测试用
    // let  csl = function(){
    //   console.log(goodsList)
    // }
    return {
      goodsList,
    };
  },
};
</script>
```

子组件 SearchSelector.vue

``` vue
<template>
  <div class="clearfix selector">
    <div class="type-wrap logo">
      <div class="fl key brand">品牌</div>
      <div class="value logos">
        <ul class="logo-list">
          <li v-for="trademark in trademarkList" :key="trademark.tmId">{{trademark.tmName}}</li>
        </ul>
      </div>
      <div class="ext">
        <a href="javascript:void(0);" class="sui-btn">多选</a>
        <a href="javascript:void(0);">更多</a>
      </div>
    </div>
    <div class="type-wrap" v-for="attr in attrsList" :key="attr.attrId">
      <div class="fl key">{{attr.attrName}}</div>
      <div class="fl value">
        <ul class="type-list">
          <li v-for="(attrValue,index) in attr.attrValueList" :key="index">
            <a>{{attrValue}}</a>
          </li>
        </ul>
      </div>
      <div class="fl ext"></div>
    </div>

    <button @click='csl'>点我测试</button>
  </div>
</template>

<script>
import { computed } from '@vue/runtime-core';
import { mapGetters, useStore } from 'vuex';

export default {
  name:'SearchSelector',
  setup() {
    
    
    const store = useStore();

    // vue3 mapGetters 写法
    const trademarkList = computed(
      mapGetters(["trademarkList"]).trademarkList.bind({ $store: store })
    );
    const attrsList = computed(
      mapGetters(["attrsList"]).attrsList.bind({ $store: store })
    );

    let csl = function(){
      console.log(trademarkList)
    }

    return {
      trademarkList,attrsList,
      csl
    };
  }
};
</script>
```





***



# day6



## search 组件参数请求监视

监视route参数变化修改searchParams 并发送请求

同时清空categoryId重新赋值

``` js
watch(route, (newValue, oldValue) => {
      searchParams.category1Id = '';
      searchParams.category2Id = '';
      searchParams.category3Id = '';
      Object.assign(searchParams, route.query, route.params);
      store.dispatch("getSearchList", searchParams);
    });
```



***



## 面包屑开发



添加删除面包屑功能

``` vue
<template>
  <div>
    <!-- 这是search模块 -->
    <type-nav />

    <!-- 搜索页面内容展示 -->
    <!--list-content-->
    <div class="main">
      <div class="py-container">
        <!--bread 面包屑 关闭筛选条件-->
        <div class="bread">
          <ul class="fl sui-breadcrumb">
            <li>
              <a href="#">全部结果</a>
            </li>
          </ul>
          <ul class="fl sui-tag">
            <li class="with-x" v-if="searchParams.categoryName">{{searchParams.categoryName}}<i @click="removeCategoryName">×</i></li>
            <li class="with-x" v-if="searchParams.keyword">{{searchParams.keyword}}<i @click="removeKeyword">×</i></li>
          </ul>
        </div>
        <!--selector-->
        <SearchSelector> </SearchSelector>
          <div class="details clearfix"> ...
          </div> 
          <div class="clearfix hot-sale"> ...
          </div>
      </div>
    </div>
    <!-- <button @click="csl">点我测试</button> -->
  </div>
</template>

<script>
import { computed, onBeforeMount, onMounted, reactive, watch, getCurrentInstance
} from "@vue/runtime-core";
import { mapGetters, useStore } from "vuex";
import { useRoute, useRouter } from "vue-router";
import SearchSelector from "./SearchSelector";
export default {
  components: { SearchSelector },
  name: "Search",
  props: ["keyword", "k"],
  // vue2 mapGetters 写法
  // computed:{
  //   ...mapGetters(['goodsList'])
  // },
  component: { SearchSelector },
  setup() {
    const store = useStore();
    const route = useRoute();
    const router = useRouter();
    const ins=getCurrentInstance();
    const bus= ins.appContext.config.globalProperties.$bus

    // 向服务器发送的请求
    let searchParams = reactive({
      category1Id: "",
      category2Id: "",
      category3Id: "",
      categoryName: "",
      keyword: "",
      order: "",
      pageNo: 1,
      pageSize: 10,
      props: [],
      trademark: "",
    });

    // 把请求封装为一个函数
    let getData = function () {
      store.dispatch("getSearchList", searchParams);
    };

    // 初始化数据
    onBeforeMount(() => {
      // searchParams.category1Id = route.query.category1Id;
      // searchParams.category2Id = route.query.category2Id;
      // searchParams.category3Id = route.query.category3Id;
      // searchParams.categoryName = route.query.categoryName;
      // searchParams.keyword = route.query.keyword;
      // searchParams.order = route.query.order;
      // searchParams.pageNo = route.query.pageNo;
      // searchParams.trademark = route.query.trademark;

      Object.assign(searchParams, route.query, route.params);
    });

    onMounted(() => {
      getData();
    });

    // 监视route 搜索界面中搜索内容时向服务器提交数据
    watch(route, (newValue, oldValue) => {
      searchParams.category1Id = '';
      searchParams.category2Id = '';
      searchParams.category3Id = '';
      Object.assign(searchParams, route.query, route.params);
      store.dispatch("getSearchList", searchParams);
    });

    // vue3 mapGetters 写法
    const goodsList = computed(
      mapGetters(["goodsList"]).goodsList.bind({ $store: store })
    );

    // 删除分类名
    let removeCategoryName = function(){
      // 清空参数使用undefined 当前数据不会带给服务器
      // 如果数据为空 会带给服务器占用带宽
      searchParams.categoryName = undefined;
      searchParams.category1Id = undefined;
      searchParams.category2Id = undefined;
      searchParams.category3Id = undefined;
      // 发送请求 进行路由跳转，路由自己跳到自己
      getData();
      if(route.params){
        router.push({name:"search",params:route.params})
      }
    }
    // 删除关键字面包屑
    let removeKeyword = function(){
      // 通知header删除关键字
      bus.emit("clearKeyword");
      searchParams.keyword = "";
      console.log(searchParams)
      if(route.query){
        router.push({name:"search",query:route.query})
      }
    }

    // 删除品牌面包屑
    let removeTrademark = function(){
      searchParams.trademark = "";
      store.dispatch("getSearchList", searchParams);
    }

    // 测试用
    // let  csl = function(){
    //   console.log(route.query)
    // }

    // 添加品牌面包屑
    function trademarkInfo (trademark){
      searchParams.trademark = `${trademark.tmId}:${trademark.tmName}`;
      getData();
    }

    return {
      goodsList,
      searchParams,
      removeCategoryName,
      removeKeyword,
      trademarkInfo,
      removeTrademark
    };
  },
};
</script>
```





清除Header组件搜索栏的内容

使用到全局事件总线

在vue3中全局事件总线部分api被删除，官方推荐使用mitt包，因此终端使用指令 ``` npm i mitt``` 安装

vue3 配置全局事件总线如下

``` js
import { createApp } from 'vue'
import App from './App.vue'

// 全局事件总线 on 函数
import mitt from "mitt"

const app = createApp(App)

// 创建事件总线
app.config.globalProperties.$bus = new mitt();

app.mount('#app')
```

search中配置触发事件

```vue
<script>
import { ...//省略代码
        getCurrentInstance
} from "@vue/runtime-core"; 
... // 省略代码
export default {
  ... // 省略代码
  setup() {
    ... // 省略代码
  
    const ins=getCurrentInstance();
    const bus= ins.appContext.config.globalProperties.$bus

    // 删除关键字面包屑
    let removeKeyword = function(){
      // 通知header删除关键字
      bus.emit("clearKeyword");
      searchParams.keyword = "";
      console.log(searchParams)
      if(route.query){
        router.push({name:"search",query:route.query})
      }
    }
    
    return {
      removeKeyword
    };
  },
};
</script>
```



header中setup 挂载中配置监听事件

清除keyword

``` vue
<script>
import { getCurrentInstance, ref } from "vue";
export default {
  name: "",
  setup() {
     ... // 省略代码
    let keyword = ref("");
    const ins=getCurrentInstance()
    const bus= ins.appContext.config.globalProperties.$bus
    onMounted(()=>{
        bus.on("clearKeyword",()=>{
          keyword.value = '';
        })
      })
      
    return {
    };
  },
};
</script>
```



品牌面包屑

配置如下

``` vue
<template>
...
	<li class="with-x" v-if="searchParams.trademark">	{{searchParams.trademark.split(':')[1]}}<i @click="removeTrademark">×</i></li>
...
</template>

<script>
... // 省略代码
export default {
  ... // 省略代码
  setup() {
    ... // 省略代码

    // 删除品牌面包屑
    let removeTrademark = function(){
      searchParams.trademark = "";
      store.dispatch("getSearchList", searchParams);
    }

    // 添加品牌面包屑
    function trademarkInfo (trademark){
      searchParams.trademark = `${trademark.tmId}:${trademark.tmName}`;
      getData();
    }
    
    return {
      trademarkInfo,
      removeTrademark
    };
  },
};
</script>
```



配置售卖属性的面包屑

``` vue
<template>
            <li class="with-x" v-if="searchParams.categoryName">{{searchParams.categoryName}}<i @click="removeCategoryName">×</i></li>
            <li class="with-x" v-if="searchParams.keyword">{{searchParams.keyword}}<i @click="removeKeyword">×</i></li>
            <li class="with-x" v-if="searchParams.trademark">{{searchParams.trademark.split(':')[1]}}<i @click="removeTrademark">×</i></li>
            <li class="with-x" v-for="(attr,index) in searchParams.props" :key="index">{{attr.split(':')[1]}}<i @click="removeAttr(index)">×</i></li>

</template>

<script>
import { computed, onBeforeMount, onMounted, reactive, watch, getCurrentInstance
} from "@vue/runtime-core";
import { mapGetters, useStore } from "vuex";
import { useRoute, useRouter } from "vue-router";
import SearchSelector from "./SearchSelector";
export default {
  ... // 省略代码
  setup() {
    const bus = ins.appContext.config.globalProperties.$bus

    // 监听售卖属性添加
    bus.on("attrInfo",(attrData)=>{
	  // 去重
      if(searchParams.props.indexOf(attrData) < 0) searchParams.props.push(attrData);
      getData()
    })

    // 删除售卖属性面包屑
    function removeAttr (index){
      // 删除某一项 并重新发送请求
      searchParams.props.splice(index,1)
      store.dispatch("getSearchList", searchParams);
    }

    return {
      removeAttr
    };
  },
};
</script>
```



***



## 商品排序

根据接口文档 

1：综合 ， 2：价格      asc：升序，  desc： 降序

默认为 综合降序  1:desc

同时动态添加类名 ``` class="active" ``` 渲染样式

这里使用了阿里的iconfont 图标



``` vue
<template>
        <div class="details clearfix">
          <div class="sui-navbar">
            <div class="navbar-inner filter">
              <!-- 排序结构 -->
              <ul class="sui-nav">
                <li :class="{ active: isSynthesize }" @click="sortSearch('1')">
                  <a href="#"
                    >综合<span v-if="isSynthesize" :class="icon"></span
                  ></a>
                </li>
                <li :class="{ active: isPrice }" @click="sortSearch('2')">
                  <a href="#">价格<span v-if="isPrice">⬇</span></a>
                </li>
              </ul>
            </div>
          </div>
</template>

<script>
... // 省略代码
export default {
... // 省略代码
  setup() {

    // 向服务器发送的请求
    let searchParams = reactive({
      category1Id: "",
      category2Id: "",
      category3Id: "",
      categoryName: "",
      keyword: "",
      order: "1:desc", // 默认排序参数
      pageNo: 1,
      pageSize: 10,
      props: [],
      trademark: "",
    });

	... // 省略代码
      
    // 选择综合排序
    let isSynthesize = computed(() => {
      return searchParams.order.indexOf("1") != -1;
    });

    // 价格排序
    let isPrice = computed(() => {
      return searchParams.order.indexOf("2") != -1;
    });

    // 排序图标
    let icon = computed(() => {
      if (searchParams.order.indexOf("desc") != -1) {
        // 降序时
        return "iconfont icon-paixu";
      } else {
        return "iconfont icon-xiangshang";
      }
    });

    // 排序搜索
    let sortSearch = function (num) {
      if (searchParams.order.indexOf(num) != -1) {
        // 同类型排序
        if (searchParams.order.indexOf("desc") != -1) {
          // 当前为降序时
          searchParams.order = num + ":" + "asc"
        } else {
          // 当前为升序时
          searchParams.order = num + ":" + "desc"
        }
      }else{ 
        // 更换类型
        searchParams.order = num + ":" + "desc"
      }
      store.dispatch("getSearchList", searchParams);
    };

    return {
      isSynthesize,
      isPrice,
      icon,
      sortSearch,
    };
  },
};
</script>
```





***



# day7



## 分页器

分页器在本项中有几处用到，我们作为全局组件注册。



**分析**

1. 需要知道当前的页码 : pageNo 为当前页码
2. 需要知道每一个需要展示多少数据: pageSize 表每页的数量
3. 需要知道整个分页器多少条数据
4. 分页器连续的页码个数: 5/7个



``` vue
<template>
<!-- 父组件使用 分页器 
... 省略代码 -->
          <pagination :pageNo='searchParams.pageNo' 
          :pageSize='4' 
          :total='91' 
          :continues='5' 
          :changePage='changePage'></pagination>
</template>

<script>
... // 省略代码
export default {
  ... // 省略代码
  setup() {

    // 向服务器发送的请求
    let searchParams = reactive({
      category1Id: "",
      category2Id: "",
      category3Id: "",
      categoryName: "",
      keyword: "",
      order: "1:desc",
      pageNo: 1,
      pageSize: 10,
      props: [],
      trademark: "",
    });

    // 页码改变
    let changePage = function(page){
        // 修改页码发送请求
      searchParams.pageNo = page;
      store.dispatch("getSearchList", searchParams);
    }

    return {
      changePage
    };
  },
};
</script>
```

分页器组件

ref 在 页签中不需要加 value 取值

​     在 js 中需要加 value 取值

``` vue
<template>
  <div class="pagination">
    <button :disabled="pageNo == 1"
    @click="prevPage">上一页</button>
    <button v-for="(page, index) in pageList" :key="index" 
    :disabled="page == -1"
    :class="{active: page == pageNo}"
    @click="changePage(page)"
    >
      {{ page > 0 ? page : "..." }}
    </button>
    <button :disabled="pageNo == totalPage" 
    @click="nextPage">下一页</button>

    <button style="margin-left: 30px">共 60 条</button>
  </div>
</template>

<script>
import { computed, ref } from "@vue/runtime-core";
export default {
  name: "Pagination",
  props: ["pageNo", "pageSize", "total", "continues", "changePage"],
  setup(props) {
    let pageNo = ref(parseInt(props.pageNo));

    let totalPage = computed(() => {
      return Math.ceil(props.total / props.pageSize);
    });

    let pageList = computed(() => {
      // list 为显示的页码列表， -1表示... 省略
      let list = [];
      let totalpage = Math.ceil(props.total / props.pageSize);
      let i = 1;
      if (totalpage > 7) {
        if (pageNo.value >= 5) {
          list.push(1);
          list.push(-1);
          if (pageNo.value < totalpage - 3) {
            // 正常页码
            for (i = pageNo.value - 2; i <= pageNo.value + 2; i++) {
              list.push(i);
            }
            list.push(-1);
            list.push(totalpage);
          } else {
            for (i = Math.min(totalpage - 4, pageNo.value - 2); i <= totalpage; i++) {
              list.push(i);
            }
          }
        } else {
          // 页码靠左
          for (i; i <= 5 || i <= pageNo.value + 2; i++) {
            list.push(i);
          }
          list.push(-1);
          list.push(totalpage);
        }
      } else {
        for (i = 1; i <= totalpage; i++) {
          list.push(i);
        }
      }

      return list;
    });

    // 修改页码
    let changePage = function(page){
      pageNo.value = page;
      console.log(page)
      props.changePage(page);
    }

    // 下一页
    let nextPage = function(){
      pageNo.value++;
      props.changePage(pageNo.value);
    }

    // 上一页
    let prevPage = function(){
      pageNo.value--;
      props.changePage(pageNo.value);
    }

    return {
      totalPage,
      pageList,
      pageNo,
      changePage,
      nextPage,
      prevPage
    };

  },
};
</script>

<style lang='less' scoped>
.pagination {
  button {
    margin: 0 5px;
    background-color: #f4f4f5;
    color: #606266;
    outline: none;
    border-radius: 2px;
    padding: 0 4px;
    vertical-align: top;
    display: inline-block;
    font-size: 13px;
    min-width: 35.5px;
    height: 28px;
    line-height: 28px;
    cursor: pointer;
    box-sizing: border-box;
    text-align: center;
    border: 0;

    &[disabled] {
      color: #c0c4cc;
      cursor: not-allowed;
    }

    &.active {
      cursor: not-allowed;
      background-color: #409eff;
      color: #fff;
    }
  }
}
</style>
```



***

## 开发某个产品的详情页面

配置路由文件 

router/routes.js添加配置如下

``` js
const routes = [
  {
    path:'/detail/:skuid',
    component:()=> import('../pages/Detail'),
    meta:{show:true}
  }
]
```

search中设置图片及商品名跳转路由

``` vue
<router-link :to="`/detail/${good.id}`">
    <img :src="good.defaultImg"/>
</router-link>
```



**滚动行为**

问题：路由跳转时跳到压面底部

解决：router/index.js 配置添加滚动行为

所有路由跳转回到顶部

``` js
const routerHistory = createWebHistory()
const router = createRouter({
  history:routerHistory,
  routes,
  scrollBehavior(to,from,savedPosition){
    return {x: 0, y: 0}
  }
})
```



**配置 参数获取 api** 

``` js
// 获取单个商品详细参数
// url: api/item/{skuid}  方式:get
// 发送请求(已经配置),返回的结果为Promise对象
export const reqGoodInfo = (skuId)=>{
  return requests({url:`/item/${skuId}`,method:'get'})
}
```



**vuex配置**

在store文件夹中新增一个 detail.js 的仓库配置如下(同时在大仓库中引入)

``` js
// detail 模块的仓库

import { reqGoodInfo } from "@/api";

const state = {
  goodInfo:{}
};
const mutations = {
  GETGOODINFO(state,goodInfo){
    state.goodInfo = goodInfo
  }
};
const actions = {
  // 获取floor 数据
  async getGoodInfo({commit}, skuId){
    let result = await reqGoodInfo(skuId);
    if(result.code == 200){
      commit("GETGOODINFO",result.data);
    }
  }
};
const getters = {
  categoryView(state){
    return state.goodInfo.categoryView || {};
  },
  skuInfo(state){
    return state.goodInfo.skuInfo || {};
  },
  skuSaleAttrValueList(state){
    if(state.goodInfo.skuInfo != undefined){
      return state.goodInfo.skuInfo.skuSaleAttrValueList
    }
    return  [];
  }
};

export default {
  state, mutations, actions, getters
}
```

商品主页面 detail.vue配置如下

``` vue
<template>
  <div class="detail">
    <!-- 商品分类导航 -->
    <type-nav />

    <!-- 主要内容区域 -->
    <section class="con">
      <!-- 导航路径区域 -->
      <div class="conPoin">
        <span v-show="categoryView.category1Name">{{
          categoryView.category1Name
        }}</span>
        <span v-show="categoryView.category2Name">{{
          categoryView.category3Name
        }}</span>
        <span v-show="categoryView.category3Name">{{
          categoryView.category3Name
        }}</span>
      </div>
      <!-- 主要内容区域 -->
      <div class="mainCon">
        <!-- 左侧放大镜区域 -->
        <div class="previewWrap">
          <!--放大镜效果-->
          <Zoom
            v-if="skuInfo.skuImageList"
            :skuImagesList="skuInfo.skuImageList"
          />
          <!-- 小图列表 -->
          <ImageList
            v-if="skuInfo.skuImageList"
            :skuImagesList="skuInfo.skuImageList"
          />
        </div>
		... 省略代码
          <div class="choose">
            <div class="chooseArea">
              <div class="choosed"></div>
              <dl
                v-for="skuSaleAttr in skuSaleAttrValueList"
                :key="skuSaleAttr.id"
              >
                <dt class="title">{{ skuSaleAttr.saleAttrName }}</dt>
                <dd changepirce="0" class="active">
                  {{ skuSaleAttr.saleAttrValueName }}
                </dd>
                <dd changepirce="40">银色</dd>
                <dd changepirce="90">黑色</dd>
              </dl>
            </div>
            ... 省略代码
</template>

<script>
import { computed, onBeforeMount, onMounted } from "@vue/runtime-core";
import ImageList from "./ImageList/ImageList";
import Zoom from "./Zoom/Zoom";
import { mapGetters, useStore } from "vuex";
import { useRoute } from "vue-router";

export default {
  name: "Detail",

  components: {
    ImageList,
    Zoom,
  },

  setup() {
    let store = useStore();
    let route = useRoute();

    onMounted(() => {
      store.dispatch("getGoodInfo", route.params.skuid);
    });
    // 获取商品信息
    const categoryView = computed(
      mapGetters(["categoryView"]).categoryView.bind({ $store: store })
    );
    const skuInfo = computed(
      mapGetters(["skuInfo"]).skuInfo.bind({ $store: store })
    );
    // 商品的售卖属性
    const skuSaleAttrValueList = computed(
      mapGetters(["skuSaleAttrValueList"]).skuSaleAttrValueList.bind({
        $store: store,
      })
    );

    return {
      categoryView,
      skuInfo,
      store,
      skuSaleAttrValueList,
    };
  },
};
</script>
```



轮播图组件  ImageList.vue 配置如下

``` vue
<template>
  <div class="swiper-container" ref="sw">
    <div class="swiper-wrapper">
      <swiper 
      :modules="modules"
      :slides-per-view="1"
      :slidesPerView="3"
      :slidesPerGroup="2"
      :navigation="{
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        }">
        <swiper-slide v-for="(slide, index) in skuImagesList" :key="slide.id">
          <img :src="slide.imgUrl" 
          :class="{ active:currentIndex == index}"
          @click="changeCurrentImageIndex(index)"/>
        </swiper-slide>
      </swiper>
    </div>
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
  </div>
</template>

<script>
// import Swiper core and required modules
import { Navigation } from "swiper";

// Import Swiper Vue.js components
import { Swiper, SwiperSlide } from "swiper/vue";
import "swiper/css";
import "swiper/css/navigation";
import { ref } from '@vue/reactivity';
import { getCurrentInstance } from '@vue/runtime-core';
export default {
  name: "ImageList",
  props: ["skuImagesList"],
  components: { Swiper, SwiperSlide },

  setup(props,) {
    let skuImagesList = props.skuImagesList;
    // 绑定默认显示的第一张图片
    let currentIndex = ref(0);

    const bus = getCurrentInstance().appContext.config.globalProperties.$bus;

    // 修改当前显示的图片
    let changeCurrentImageIndex = function(index){
      currentIndex.value = index;
      // 通知 zoom修改图片
      bus.emit("changeCurrentImage",index)
    }

    return { 
      modules: [Navigation],
      skuImagesList,
      currentIndex,
      changeCurrentImageIndex
    };
  },
};
</script>

<style lang="less" scoped>
.swiper-container {
  height: 56px;
  width: 412px;
  box-sizing: border-box;
  padding: 0 12px;

  .swiper-slide {
    width: 56px;
    height: 56px;

    img {
      width: 100%;
      height: 100%;
      border: 1px solid #ccc;
      padding: 2px;
      width: 50px;
      height: 50px;
      display: block;

      &.active {
        border: 2px solid #f60;
        padding: 1px;
      }

      &:hover {
        border: 2px solid #f60;
        padding: 1px;
      }
    }
  }

  .swiper-button-next {
    left: auto;
    right: 0;
  }

  .swiper-button-prev {
    left: 0;
    right: auto;
  }

  .swiper-button-next,
  .swiper-button-prev {
    box-sizing: border-box;
    width: 12px;
    height: 56px;
    background: rgb(235, 235, 235);
    border: 1px solid rgb(204, 204, 204);
    top: 400px;
    margin-top: 0;
    &::after {
      font-size: 12px;
    }
  }
}
</style>
```

重点 **图片放大镜效果** 组件

``` vue
<template>
  <div class="spec-preview">
    <img :src="defaultImage" />
    <div class="event" @mousemove="handler"></div>
    <div class="big">
      <img :src="defaultImage" ref="bigImage"/>
    </div>
    <div class="mask" ref="maskBox"></div>
  </div>
</template>

<script>
import { ref } from "@vue/reactivity";
import { getCurrentInstance, onBeforeUnmount, onMounted } from "@vue/runtime-core";

export default {
  name: "Zoom",
  props: ["skuImagesList"],

  setup(props) {
    const bus = getCurrentInstance().appContext.config.globalProperties.$bus;

    // 设置默认图片(第一张)
    let defaultImage = ref(props.skuImagesList[0].imgUrl);

    onMounted(() => {
      // 监听 ImageList 修改图片
      bus.on("changeCurrentImage", (index) => {
        defaultImage.value = props.skuImagesList[index].imgUrl;
      });
    });

    onBeforeUnmount(()=>{
      bus.off("changeCurrentImage");
    });

    // 绑定DOM
    let maskBox = ref(null);
    let bigImage = ref(null);

    let handler = function(event){
      // 通过DOM获取鼠标移动事件参数
      let left = event.offsetX - maskBox.value.offsetWidth/2;
      let top = event.offsetY - maskBox.value.offsetHeight/2;

      // 确定边界
      if(left <= 0) left = 0;
      if(left >= maskBox.value.offsetWidth) left = maskBox.value.offsetWidth;
      if(top <= 0) top = 0;
      if(top >= maskBox.value.offsetHeight) top = maskBox.value.offsetHeight;
      
      // 遮罩层(绿色的那块)移动
      maskBox.value.style.left = left + 'px';
      maskBox.value.style.top = top + 'px';
      // 放大镜效果，图片窗口不动，让大图片反方向移动两倍的小图移动距离
      bigImage.value.style.left = -2 * left + 'px';
      bigImage.value.style.top = -2 * top + 'px';
    }

    return { 
    defaultImage,
    handler,
    maskBox,
    bigImage
    };
  },
};
</script>

<style lang="less">
.spec-preview {
  position: relative;
  width: 400px;
  height: 400px;
  border: 1px solid #ccc;

  img {
    width: 100%;
    height: 100%;
  }

  .event {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 998;
  }

  .mask {
    width: 50%;
    height: 50%;
    background-color: rgba(0, 255, 0, 0.3);
    position: absolute;
    left: 0;
    top: 0;
    display: none;
  }

  .big {
    width: 100%;
    height: 100%;
    position: absolute;
    top: -1px;
    left: 100%;
    border: 1px solid #aaa;
    overflow: hidden;
    z-index: 998;
    display: none;
    background: white;

    img {
      width: 200%;
      max-width: 200%;
      height: 200%;
      position: absolute;
      left: 0;
      top: 0;
    }
  }

  .event:hover ~ .mask,
  .event:hover ~ .big {
    display: block;
  }
}
</style>
```



***

# day8

## 购物车开发

功能：

1. 添加数量配置(最少为1)
2. 发送请求添加商品到购物车
3. 成功后会话存储数据(转为JSON格式存储)



***

# day9

## 购物车

1. 修改购物车样式

2. 向服务器发起ajax请求，vuex保存

3. uuid临时游客身份

   本地保存身份id

4. 动态展示购物车

   购物车数据样式修改：商品选中、全选中、数量修改(防抖)发送请求

   计算选中商品的价格

   删除所有选中的商品(多promise发送请求)



加入商品到购物车成功的页面

``` vue
<template>
  <div class="cart-complete-wrap">
    <div class="cart-complete">
      <h3><i class="sui-icon icon-pc-right"></i>商品已成功加入购物车！</h3>
      <div class="goods">
        <div class="left-good">
          <div class="left-pic">
            <img :src="skuInfo.skuDefaultImg">
          </div>
          <div class="right-info">
            <p class="title">{{skuInfo.skuName}}</p>
            <p class="attr">{{skuInfo.skuDesc}} 数量：{{skuNum}}</p>
          </div>
        </div>
        <div class="right-gocart">
          <router-link class="sui-btn btn-xlarge" :to="`/detail/${skuInfo.id}`">查看商品详情</router-link>
          <router-link to="/shopcart">去购物车结算 ></router-link>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { reactive } from '@vue/runtime-core'
import { useRoute } from 'vue-router'

  export default {
    name: 'AddCartSuccess',
    setup() {
        // 商品信息会话存储
      const skuInfo = reactive(JSON.parse(sessionStorage.getItem("SKUINFO")))
      const route = useRoute();
      let skuNum = route.query.skuNum

      
      return {skuInfo,skuNum}
    }
  }
</script>
```



api/index.js中配置请求接口

``` js
// 将产品添加到购物车中
export const reqAddOrUpdateShopCart = (skuId,skuNum)=>{
  return requests({url:`/cart/addToCart/${skuId}/${skuNum}`,method:'post'})
}

// 获取购物车数据
export const reqCartList = ()=>{
  return requests({url:`/cart/cartList`,method:'get'})
}

// 删除商品
export const reqDelSku = (skuId)=>{
  return requests({url:`/cart/deleteCart/${skuId}`,method:'delete'})
}

// 修改商品选中状态
export const reqChangeSkuIsChecked = (skuId,isChecked)=>{
  return requests({url:`/cart/checkCart/${skuId}/${isChecked}`,method:'get'})
}
```

购物车页面配置

``` vue
<template>
  <div class="cart">
    <h4>全部商品</h4>
    <div class="cart-main">
      <div class="cart-th">
        <div class="cart-th1">全部</div>
        <div class="cart-th2">商品</div>
        <div class="cart-th3">单价（元）</div>
        <div class="cart-th4">数量</div>
        <div class="cart-th5">小计（元）</div>
        <div class="cart-th6">操作</div>
      </div>
      <div class="cart-body">
        <ul class="cart-list" v-for="sku in cartList" :key="sku.skuId">
          <li class="cart-list-con1">
            <input
              type="checkbox"
              name="chk_list"
              :checked="sku.isChecked == 1"
              @click="changeIsChecked(sku)"
            />
          </li>
          <li class="cart-list-con2">
            <img :src="sku.imgUrl" />
            <div class="item-msg">{{ sku.skuName }}</div>
          </li>
          <li class="cart-list-con4">
            <span class="price">{{ sku.skuPrice }}</span>
          </li>
          <li class="cart-list-con5">
            <a
              href="javascript:void(0)"
              class="mins"
              @click="changeSkuNum(-1, sku)"
              >-</a
            >
            <input
              autocomplete="off"
              type="number"
              :value="sku.skuNum"
              @blur="writeSkuNum(sku)"
              minnum="1"
              class="itxt"
            />
            <a
              href="javascript:void(0)"
              class="plus"
              @click="changeSkuNum(1, sku)"
              >+</a
            >
          </li>
          <li class="cart-list-con6">
            <span class="sum">{{ sku.skuNum * sku.skuPrice }}</span>
          </li>
          <li class="cart-list-con7">
            <a href="#none" class="sindelet" @click="deleteSku(sku.skuId)"
              >删除</a
            >
            <br />
            <a href="#none">移到收藏</a>
          </li>
        </ul>
      </div>
    </div>
    <div class="cart-tool">
      <div class="select-all">
        <input
          class="chooseAll"
          type="checkbox"
          :checked="isCheckedAll"
          @click="changeAllChecked(isCheckedAll)"
        />
        <span>全选</span>
      </div>
      <div class="option">
        <a href="#none" @click="deleteAllChecked">删除选中的商品</a>
        <a href="#none">移到我的关注</a>
        <a href="#none">清除下柜商品</a>
      </div>
      <div class="money-box">
        <div class="chosed">已选择 <span>0</span>件商品</div>
        <div class="sumprice">
          <em>总价（不含运费） ：</em>
          <i class="summoney">{{ sum }}</i>
        </div>
        <div class="sumbtn">
          <button @click="test">测试</button>
          <a class="sum-btn" href="###" target="_blank">结算</a>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { computed, onMounted } from "@vue/runtime-core";
import { mapGetters, useStore } from "vuex";
export default {
  name: "ShopCart",
  setup(props) {
    const store = useStore();

    let getData = async function () {
      try {
        await store.dispatch("getCartList")
      } catch (error) {
        console.log(error)
      }
    };

    let cartList = computed(
      mapGetters(["cartList"]).cartList.bind({ $store: store })
    );

    onMounted(() => {
      getData();
    });

    let sum = computed(() => {
      let total = 0;
      // 判断是否有数据
      if (cartList.value) {
        total = cartList.value.reduce((total, cart) => {
          if (cart.isChecked) {
            total += cart.skuNum * cart.skuPrice;
          }
          return total;
        }, 0);
      }
      return total;
    });

      // 判断是否为全选
    let isCheckedAll = computed(() => {
      if (cartList.value) {
        return cartList.value.every((item) => item.isChecked);
      }
      return false;
    });

    let test = function () {
      console.log(cartList.value);
    };
      
    // 全选改变商品选项
    let checkedAll = function () {
      if (isCheckedAll.value) {
        cartList.value.forEach((sku) => {
          sku.isChecked = 0;
        });
      } else {
        cartList.value.forEach((sku) => {
          sku.isChecked = 1;
        });
      }
    };

    // 防抖操作，完成点击修改商品数量0.7s后发送请求
    let skuValue = 0;
    let timer;
    let changeSkuNum = function (changeValue, sku) {
      // 判断变化是否小于等于1，如果是则退出
      if (changeValue + sku.skuNum < 1) {
        return;
      }
      console.log(changeValue);
      skuValue += changeValue;
      sku.skuNum += changeValue;
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => {
        // 发送请求
        console.log(skuValue);
        const skuAdd = { skuId: sku.skuId, skuNum: skuValue };
        store.dispatch("addOrUpdateShopCart", skuAdd);
        skuValue = 0;
      }, 700);
    };
	// 输入框失去焦点后更改商品数量
    let writeSkuNum = function (sku) {
      console.log(sku);
      if (event.target.value < 1) event.target.value = 1;
      skuValue = event.target.value - sku.skuNum;
      console.log(skuValue);
      const skuAdd = { skuId: sku.skuId, skuNum: skuValue };
      skuValue = 0;
      store.dispatch("addOrUpdateShopCart", skuAdd).then(
        setTimeout(() => {
          getData();
        }, 100)
      );
    };

    // 删除商品
    let deleteSku = async function (skuId) {
      try {
        await store.dispatch("delSku", skuId)
      } catch (error) {
        console.log(error)
      }
    };

    // 改变选中状态
    let changeIsChecked = async function (sku) {
      sku.isChecked = !sku.isChecked;
      let isChecked = sku.isChecked ? "1" : "0";
      try {
        await store.dispatch("changeSkuIsChecked", { skuId: sku.skuId, isChecked })
      } catch (error) {
        console.log(error)
      }
    };

    // 删除全部选中的商品
    let deleteAllChecked =async function () {
      try {
        await store.dispatch("deleteAllChecked")
        getData()
      } catch (error) {
        console.log(error)
      }
    };

    // 所有商品选中
    let changeAllChecked =async function (isCheckedAll) {
      let changeValue = !isCheckedAll ? "1" : "0"
      try {
        await store.dispatch("allChecked",changeValue)
        getData()
      } catch (error) {
        console.log(error)
      }
    };

    return {
      cartList,
      sum,
      test,
      isCheckedAll,
      checkedAll,
      changeSkuNum,
      writeSkuNum,
      deleteSku,
      changeIsChecked,
      deleteAllChecked,
      changeAllChecked
    };
  },
};
</script>
```

vuex配置新的仓库cart

``` js
// cart 模块的仓库

import { reqCartList, reqDelSku, reqChangeSkuIsChecked } from "@/api";

const state = {
  carList: []
};
const mutations = {
  GETCARTLIST(state, cartList) {
    state.carList = cartList
  }
};
const actions = {
  // 发送请求获取购物车数据
  async getCartList({ commit }) {
    let result = await reqCartList();
    if (result.code == 200) {
      commit("GETCARTLIST", result.data[0].cartInfoList)
    }
  },
  // 发送请求删除商品
  async delSku({ commit },skuId) {
    let result = await reqDelSku(skuId);
    if (result.code == 200) {
      return 'ok'
    }else{
      return Promise.reject('fail')
    }
  },
  // 修改商品是否选中
  async changeSkuIsChecked({ commit },{skuId,isChecked}) {
    let result = await reqChangeSkuIsChecked(skuId,isChecked);
    if (result.code == 200) {
      return 'ok'
    }else{
      return Promise.reject('fail')
    }
  },
  // 删除全部选中的商品
  deleteAllChecked({ dispatch,getters }) {
    // context:小仓库：commit【提交mutations】 getters【计算属性】 dispatch【派发action】
    let PromiseAll = []
    getters.cartList.forEach(item => {
      if(item.isChecked == 1){
        let promise = dispatch('delSku',item.skuId)
        PromiseAll.push(promise)
      }
    });
    // 只要全部都成功才能成功
    // 有一个失败则算作失败
    return Promise.all(PromiseAll)
  },
  allChecked({ dispatch,getters },changeValue) {
    // context:小仓库：commit【提交mutations】 getters【计算属性】 dispatch【派发action】
    let PromiseAll = []
    getters.cartList.forEach(item => {
      if(item.isChecked != changeValue){
        let promise = dispatch('changeSkuIsChecked',{skuId:item.skuId,isChecked:changeValue})
        PromiseAll.push(promise)
      }
    });
    // 只要全部都成功才能成功
    // 有一个失败则算作失败
    return Promise.all(PromiseAll)
  }
};
const getters = {
  cartList(state) {
    return state.carList
  }
};

export default {
  state, mutations, actions, getters
}
```



***

# day10

1. 登录与注册静态组件(配置好图片等)

   登陆发送请求后服务器会返回数据(里面有token)

   一般登陆服务器只发送token，前端要在本地存储token(一天以上)

2. assets 文件夹——防止全组件共用静态资源



api/index.js配置

``` js
// 获取验证码
export const reqGetCode = (phone)=>{
  return requests({url:`/user/passport/sendCode/${phone}`,method:'get'})
}

// 注册账号
export const reqRegister = (data)=>{
  return requests({url:`/user/passport/register`,data,method:'post'})
}

// 登陆账号
export const reqLogin = (data)=>{
  return requests({url:`/user/passport/login`,data,method:'post'})
}

// 获取用户信息
export const reqUserInfo = (data)=>{
  return requests({url:`/user/passport/auth/getUserInfo`,method:'get'})
}

// 退出登陆
export const reqLogout = (data)=>{
  return requests({url:`/user/passport/logout`,method:'get'})
}

```

api/request.js中配置请求拦截器,添加token/uuid信息

``` js
// 对于axios进行二次封装

import axios from 'axios';
// 引入进度条
import nprogress from 'nprogress';
// start ：进度条开始      done:进度条结束
// 引入进度条样式
import 'nprogress/nprogress.css';

import store from '@/store';

// 利用axios 方法create 创建一个实例
// request 就是 axios
const requests = axios.create({
  // 基础路径
  baseURL:'/api',
  // 代表请求超时时间为5s
  timeout:5000,
});

// 请求拦截器,发请求前，请求拦截器可以拦截，可以执行部分代码
requests.interceptors.request.use((config)=>{
  if(store.state.detail.uuid_token){
    // 给请求头添加userTempId(与后端协商好了)
    config.headers.userTempId = store.state.detail.uuid_token
  }
  // 给请求头添加token
  if(store.state.user.token){
    config.headers.token = store.state.user.token
    console.log(config.headers.token)
  }
  // 进度条开始
  nprogress.start();
  // config 为配置对象，
  //里面有header 请求头
  return config
})

// 响应拦截器
requests.interceptors.response.use((res)=>{
  // 进度条结束
  nprogress.done();
  // 响应成功文档
  return res.data
},(error)=>{
  // 进度条结束
  nprogress.done();
  // 响应失败的回调函数
  return Promise.reject(new error('faild'))
})

export default requests;
```

配置utils 获取设置本地存储uuid 与 token 工具

uuid.js

``` js
import {v4 as uuidv4} from 'uuid'

export const getUUID = () =>{
  // 先从本地存储查找uuid
  let uuid_token = localStorage.getItem('UUIDTOKEN')
  if(!uuid_token){
    // 如果没有临时生成身份
    uuid_token = uuidv4()
    // 本地存储一次
    localStorage.setItem('UUIDTOKEN',uuid_token)
    return uuid_token
  }else{
    // 如果有直接返回
    return uuid_token
  }
}
```

token.js

``` js
export const setToken = (token)=>{
  localStorage.setItem('TOKEN',token)
}

export const getToken = ()=>{
  return localStorage.getItem('TOKEN')
}
```

vuex 新建user仓库并在大仓库中导入该仓库

``` js
// 登录与注册模块的仓库

// 引入搜索函数
import { reqGetCode, reqLogin, reqLogout, reqRegister, reqUserInfo } from "@/api";
import { setToken, getToken } from "@/utils/token";


const state = {
  code:'',
  token:getToken(),
  userInfo:{}
};
const mutations = {
  GETCODE(state,code){
    state.code = code
  },
  LOGIN(state,data){
    state.token = data.token
  },
  USERINFO(state,data){
    state.userInfo = data
  },
  // 清理token
  CLEAR(state){
    state.token = '',
    state.userInfo = {},
    setToken('')
  }
};
const actions = {
  // 获取验证码请求,正常情况是发送到用户的手机上
  async getCode({commit},phone){
    let result = await reqGetCode(phone)
    if(result.code== 200){
      commit('GETCODE',result.data)
      return Promise.resolve('成功')
    }else{
      return Promise.reject(new Error('fail'))
    }
  },
  // 注册账号
  async register({commit},user){
    let result = await reqRegister(user)
    console.log(result,'res')
    if(result.code== 200){
      return '成功'
    }else{
      return Promise.reject(new Error('fail'))
    }
  },
  // 登陆账号
  async login({commit},user){
    let result = await reqLogin(user)
    console.log(result,'登陆账号')
    if(result.code== 200){
      commit('LOGIN',result.data)
      setToken(result.data.token)
      return '成功'
    }else{
      return Promise.reject(new Error('fail'))
    }
  },
  // 获取用户信息
  async getUserInfo({commit},user){
    let result = await reqUserInfo(user)
    console.log(result,'获取用户信息')
    if(result.code== 200){
      commit('USERINFO',result.data)
      return '成功'
    }else{
      commit('CLEAR')
      console.log('token失效,清理token')
      return Promise.reject(new Error('获取用户信息失败，请重新登陆'))
    }
  },
  // 退出登陆
  async userLogout({commit},user){
    let result = await reqLogout(user)
    if(result.code== 200){
      commit('CLEAR')
      return '成功'
    }else{
      return Promise.reject(new Error('fail'))
    }
  }
};
const getters = {
};

export default{
  state, mutations, actions, getters
}
```




***

# day11

1. 持久化存储token

   Header组件挂载时候判断是否有token，有则获取用户信息，失效则清理token

login.vue 路由组件

``` vue
<template>
  <div class="login-container">
    <!-- 登录 -->
    <div class="login-wrap">
      <div class="login">
        <div class="loginform">
          <ul class="tab clearFix">
            <li>
              <a href="##" style="border-right: 0;">扫描登录</a>
            </li>
            <li>
              <a href="##" class="current">账户登录</a>
            </li>
          </ul>

          <div class="content">
            <form>
              <div class="input-text clearFix">
                <span></span>
                <input type="text" placeholder="邮箱/用户名/手机号" v-model="phone">
              </div>
              <div class="input-text clearFix">
                <span class="pwd"></span>
                <input type="text" placeholder="请输入密码" v-model="password">
              </div>
              <div class="setting clearFix">
                <label class="checkbox inline">
                  <input name="m1" type="checkbox" value="2" checked="">
                  自动登录
                </label>
                <span class="forget">忘记密码？</span>
              </div>
              <button class="btn" @click.prevent="login">登&nbsp;&nbsp;录</button>
            </form>

            <div class="call clearFix">
              <ul>
                <li><img src="./images/qq.png" alt=""></li>
                <li><img src="./images/sina.png" alt=""></li>
                <li><img src="./images/ali.png" alt=""></li>
                <li><img src="./images/weixin.png" alt=""></li>
              </ul>
              <router-link class="register" to="/register">立即注册</router-link>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 底部 -->
    <div class="copyright">
      <ul>
        <li>关于我们</li>
        <li>联系我们</li>
        <li>联系客服</li>
        <li>商家入驻</li>
        <li>营销中心</li>
        <li>手机尚品汇</li>
        <li>销售联盟</li>
        <li>尚品汇社区</li>
      </ul>
      <div class="address">地址：北京市昌平区宏福科技园综合楼6层</div>
      <div class="beian">京ICP备19006430号
      </div>
    </div>
  </div>
</template>

<script>
import { ref } from '@vue/reactivity'
import { useStore } from 'vuex'
import { useRouter } from 'vue-router'
  export default {
    name: 'Login',
    setup(props) {

      const store = useStore()
      const router = useRouter()

      let phone = ref('')
      let password = ref('')
      
      // 登录
      let login =async function(){
        try {
          const user = {phone:phone.value,password:password.value}
          // 成功获取token 通过token 获取用户信息
          store.dispatch('login',user).then(v=>{
            store.dispatch('getUserInfo')
          })
          // 成功并跳转到首页
          router.push('/home')
        } catch (error) {
          alert(error)
        }
      }

      return{
        phone,
        password,
        login
      }
    }
  }
</script>
```

register.vue 注册路由组件配置

``` vue
<template>
  <div class="register-container">
    <!-- 注册内容 -->
    <div class="register">
      <h3>
        注册新用户
        <span class="go"
          >我有账号，去 <a href="login.html" target="_blank">登陆</a>
        </span>
      </h3>
      <div class="content">
        <label>手机号:</label>
        <input type="text" placeholder="请输入你的手机号" v-model="phone" />
        <span class="error-msg">错误提示信息</span>
      </div>
      <div class="content">
        <label>验证码:</label>
        <input type="text" placeholder="请输入验证码" v-model="code" />
        <button style="width: 100px; height: 39px" @click="getCode">
          获取验证码
        </button>
        <span class="error-msg">错误提示信息</span>
      </div>
      <div class="content">
        <label>登录密码:</label>
        <input
          type="password"
          placeholder="请输入你的登录密码"
          v-model="password"
        />
        <span class="error-msg">错误提示信息</span>
      </div>
      <div class="content">
        <label>确认密码:</label>
        <input
          type="password"
          placeholder="请输入确认密码"
          v-model="comfirmPassword"
        />
        <span class="error-msg" v-show="comfirmPasswordError">错误提示信息</span>
      </div>
      <div class="controls">
        <input name="m1" type="checkbox" :checked="isChecked" @click="changeFuckKing"/>
        <span>同意协议并注册《尚品汇用户协议》</span>
        <span class="error-msg">错误提示信息</span>
      </div>
      <div class="btn">
        <button @click="register">完成注册</button>
      </div>
    </div>

    <!-- 底部 -->
    <div class="copyright">
      <ul>
        <li>关于我们</li>
        <li>联系我们</li>
        <li>联系客服</li>
        <li>商家入驻</li>
        <li>营销中心</li>
        <li>手机尚品汇</li>
        <li>销售联盟</li>
        <li>尚品汇社区</li>
      </ul>
      <div class="address">地址：北京市昌平区宏福科技园综合楼6层</div>
      <div class="beian">京ICP备19006430号</div>
    </div>
  </div>
</template>

<script>
import { ref } from "@vue/reactivity";
import { useStore } from "vuex";
import { computed } from '@vue/runtime-core';
export default {
  name: "Register",
  setup(props) {
    const store = useStore();

    let phone = ref("");
    let code = ref("");
    let password = ref("");
    let comfirmPassword = ref("");
    let isChecked = ref(false)

    // 获取验证码
    let getCode = async function () {
      let temp = store.state.user.code;
      await store.dispatch("getCode", phone.value).then((value) => {
        // 等待请求结果后
        if (store.state.user.code != temp) {
          code.value = store.state.user.code
        }
      }).catch(error=>{
        console.log(error)
      })
    };

    // 确认密码错误提示
    let comfirmPasswordError = computed(()=>{
      if(comfirmPassword.value.length > 0 && comfirmPassword.value !== password.value){
        return true
      }
      return false
    })

    // 改变isChecked霸王条款同意状态
    let changeFuckKing = function(){
      isChecked.value = !isChecked.value
    }

    // 注册账号
    let register = async function(){
      const data = {
        phone:phone.value,
        code:code.value,
        password:password.value
      }
      if(data.phone && data.code && data.password === comfirmPassword.value){
        let req = await store.dispatch('register',data).then(value=>{
          console.log(value)
        },error=>{
          console.log(error)
        })
      }
    }

    return {
      phone,
      code,
      password,
      comfirmPassword,
      isChecked,
      getCode,
      comfirmPasswordError,
      changeFuckKing,
      register
    };
  },
};
</script>
```

在 header.vue组件中配置获取用户信息

``` vue
<template>
  <!-- 头部 -->
  <header class="header">
    <!-- 头部的第一行 -->
    <div class="top">
      <div class="container">
        <div class="loginList">
          <p>尚品汇欢迎您！</p>
          <p v-if="!haveUserInfo">
            <span>请</span>
            <router-link to="/login">登录</router-link>
            <router-link class="register" to="/register">免费注册</router-link>
          </p>
          <p v-else>
            <router-link to="/login">{{userName}}</router-link>
            <a class="register" @click="logout">退出登陆</a>
          </p>
        </div>
        <div class="typeList">
          <a href="###">我的订单</a>
          <router-link to="/shopcart">我的购物车</router-link>
          <a href="###">我的尚品汇</a>
          <a href="###">尚品汇会员</a>
          <a href="###">企业采购</a>
          <a href="###">关注尚品汇</a>
          <a href="###">合作招商</a>
          <a href="###">商家后台</a>
        </div>
      </div>
    </div>
    <!--头部第二行 搜索区域-->
    <div class="bottom">
      <h1 class="logoArea">
        <router-link class="logo" to="/home">
          <img src="./images/logo.png" alt="" />
        </router-link>
      </h1>
      <div class="searchArea">
        <form action="###" class="searchForm">
          <input
            type="text"
            id="autocomplete"
            class="input-error input-xxlarge"
            v-model="keyword"
          />
          <button
            class="sui-btn btn-xlarge btn-danger"
            type="button"
            @click="goSearch"
          >
            搜索
          </button>
        </form>
      </div>
    </div>
  </header>
</template>

<script>
import { useRoute, useRouter } from "vue-router";
import { onMounted, ref, getCurrentInstance, onBeforeUnmount, computed } from "vue";
import { useStore } from 'vuex';
export default {
  name: "",
  setup() {
    const store = useStore()
    const router = useRouter();
    const route = useRoute();
    let keyword = ref("");
    const ins=getCurrentInstance()
    const bus= ins.appContext.config.globalProperties.$bus
    let goSearch = function () {
      // 字符串形式传参 搜索跳转路由 可传params
      // router.push('/search/'+this.keyword +'?k=' + this.keyword.toUpperCase())
      // 对象传参 params 需要路由命名
      let location = {
        name: "search",
        params: { keyword: this.keyword || undefined },
      };
      if (route.query) {
        location.query = route.query;
      }
      router.push(location);
      // 其他对象写法
      // router.push({path:'/search/'+this.keyword,query:{k:this.keyword.toUpperCase()}})
    }
    
    onMounted(()=>{
        bus.on("clearKeyword",()=>{
          keyword.value = '';
        });
        // 如果有token 则获取信息
        if(store.state.user.token){
          try {
            store.dispatch('getUserInfo')
          } catch (error) {
            // 失效错误，清理token重新登陆
            console.log(error)
          }
        }
      })

    onBeforeUnmount(()=>{
      bus.off("clearKeyword")
    })
	// 确认是否显示用户信息
    let haveUserInfo = computed(()=>{
      if(store.state.user.userInfo.name){
        userName.value = store.state.user.userInfo.name
        return true
      }
      return false
    })

    let userName = ref('')

    // 退出登陆
    let logout = function(){
      // 向服务器发送通知
      try {
        store.dispatch('userLogout')
        router.push('home')
      } catch (error) {
        console.log(error)
      }
    }
    return {
        goSearch,
        keyword,
        haveUserInfo,
        userName,
        logout
    };
  },
};
</script>
```



***

# day12

支付成功






***

# 错误信息



##  app.component is not a function



如下写法为错误写法

``` js
import { createApp } from 'vue'
import App from './App.vue'

// 引入路由
import router from '@/router'
// 三级联动组件 全局注册
import TypeNav from '@/pages/Home/TypeNav'

const app = createApp(App).use(router).mount('#app')
app.component('typenav',TypeNav)
```

因为 ``` .mount('#app')``` 本身不返回对象，因此在下面注册全局组件时候会发生错误，



改为

``` js
import { createApp } from 'vue'
import App from './App.vue'

// 引入路由
import router from '@/router'
// 三级联动组件 全局注册
import TypeNav from '@/pages/Home/TypeNav'
const app = createApp(App)

app.use(router)
app.component('typenav',TypeNav)
app.mount('#app')
```





***



## push is not a func

在vue-devtools 6.0 beta插件容易与 router.push冲突

**解决办法**：尝试其他开发者工具



***

## 数据与子组件挂载异步问题

如下为一个子组件

```js 
<Zoom :skuImagesList="skuInfo.skuImageList" /> 
```

它传入的数据来自ajax请求。

在vue中父子组件的挂载顺序是

子组件渲染完成挂载在父组件上，然后父组件渲染完成后挂载，但是ajax请求放在onMounted中



附上父子组件生命周期顺序

**1、父子组件的加载顺序为**
父beforeCreated ->父created ->父beforeMounted ->子beforeCreated ->子created ->子beforeMounted ->子mounted -> 父mounted

**2、父组件更新顺序为**
父beforeUpdate->父updated

**3、子组件更新顺序为**
父beforeUpdate->子beforeUpdate->子updated->父updated

**4、父子组件销毁顺序为**
父beforeDestroy->子beforeDestroy->子destroyed->父destroyed



**解决办法**

1. 子组件设置watch props监视更新数据
2. 使用 v-if 来延迟渲染子组件``` <Zoom v-if="skuInfo.skuImageList" :skuImagesList="skuInfo.skuImageList" />```

另外 ajax请求可以放在父组件 created 之后操作

